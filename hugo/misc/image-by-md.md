---
title: "画像ファイルを Markdown ファイルと同じディレクトリに置く"
date: "2019-10-19"
---

Markdown ファイルと画像ファイルを同じディレクトリに置いたときの不都合
----

初期の頃の Hugo では、画像ファイルは `static` ディレクトリに置いて、記事ファイル (Markdown) と別々のディレクトリで管理するという方法がとられていました。
しかし、これでは Markdown ファイルと画像ファイルをバラバラに管理しないといけないというユーザーの不満が出て、現状は `content` ディレクトリ以下に一緒に配置できるようになっています。

- content/
    - dir1/
        - sample.md
        - sample.png

Markdown ファイルの中では、Markdown の文法、あるいは Hugo 組み込みの `figure` ショートコードを使って画像タグ (img) を出力できるのですが、これではうまく表示できないことがあります（画像ファイルが見つからない 404 エラーになる）。

```
![Title](sample.png)
```

```
{{ "{{" }}< figure src="sample.png" >}}
```

なぜなら、[Ugly URLs の設定](https://gohugo.io/content-management/urls/#ugly-urls) や、インデックスページの出力先の仕様によって、HTML ファイルと画像ファイルの出力先が一階層ズレてしまうことがあるからです。
Markdown のフロントマターで `url` プロパティなどを指定して、HTML ファイルの出力先を変更した場合にも、画像ファイルの出力先はうまく追従してくれません。

こういった階層のズレに対応するために、毎回ディレクトリパスの調整を入れて記述するのはとても大変です。
そこで、このような階層のズレが発生しないように、独自の `image` ショートコードを作成してみます。


image ショートコードを作成する
----

下記の `image` ショートコードを使用すると、Markdown ファイルと同じ階層に置いた画像ファイルを表示することができます。
ここでは分かりやすさを重視して最小限のコードを示していますので、CSS クラスなどは適宜追加してください。

#### layouts/shortcodes/image.html

```
{{ "{{" }}- $src := .Get "src" -}}
{{ "{{" }}- $title := .Get "title" -}}
{{ "{{" }}- $dir := path.Join "/" (path.Dir .Page.File.Path) -}}

<figure>
  <img src="{{ "{{" }} $dir }}/{{ "{{" }} $src }}" />
  {{ "{{" }}- with $title }}
    <figcaption>{{ "{{" }} . }}</figcaption>
  {{ "{{" }}- end }}
</figure>
```

ポイントは `$dir` 変数に Markdown ファイルのディレクトリパスを取得しているあたりです。
これを利用して、`img` タグに出力する画像ファイルのパスをうまく組み立てています。

この `image` ショートコードは、Markdown ファイルの中から下記のように使用します。

#### content/dir1/sample.md

```
---
title: "サンプル"
date: "2019-10-19"
---

下記は image ショートコードの使用例です。

{{ "{{" }}< image src="sample.png" title="サンプル画像" >}}
```

`src` パラメータは必須ですが、`title` パラメータは省略できます。

